<div class="card-deploy">
  <div class="card_header" ng-click="editStepName($ctrl.step)">
    <h3 ng-if="!name && !isEditingName">Step {{$ctrl.step}}</h3>
    <p ng-if="name && !isEditingName">{{name}}</p>
    <div class="name_input" ng-if="isEditingName">
      <input type="text" ng-model="$parent.name"/>
      <button class="btn btn-xs btn-success" ng-click="saveName($event, $ctrl.step)">Ok</button>
    </div>
    <i class="fa fa-trash-o" ng-show="allowDelete" ng-click="handleDeleteCard($ctrl.step)"/>
  </div>
  <hr/>
  <div style="margin-bottom: 10px;">
    <span>Choose domain:</span>
    <select style="width: 170px" ng-disabled="isDisabledFields" ng-model="domain" ng-change="setDomain($ctrl.step)">
      <option ng-repeat="(key, domain) in domainsList">{{domain}}</option>
    </select>
    <span>Choose action:</span>
    <select style="width: 170px" ng-disabled="isDisabledFields" ng-model="action" ng-change="setAction($ctrl.step)">
      <option ng-repeat="act in actionsList" ng-value="act.id">{{act.name}}</option>
    </select>
    <div>
      <input id="picker" ng-disabled="isDisabledFields" type="checkbox" ng-model="ispicker" ng-change="setPicker($ctrl.step)"/>
      <label for="picker">Composer step</label>
    </div>
    <div>
      <input id="setuper" ng-disabled="isDisabledFields" type="checkbox" ng-model="isdeployer" ng-change="setDeployer($ctrl.step)"/>
      <label for="setuper">Deployer step</label>
    </div>
    <div class="points_container" ng-if="points.length">
      <p class="points_label">KEY POINTS</p>
      <div class="points_table_wrapper">
        <table>
          <tr ng-repeat="(idx, point) in points">
            <td>{{point.key}}</td>
            <td><i class="fa fa-trash-o" ng-show="allowDelete" ng-click="handleDeletePoint($ctrl.step, idx)"/></td>
          </tr>
        </table>
      </div>
    </div>
    <button class="btn btn-primary" style="width: 100%;" ng-click="handleAddPoint($ctrl.step)">ADD POINT</button>
    <div class="log" ng-if="current.job && status === 'successful'">
      <i class="fa fa-eye"></i>
      <span class="log_view" ng-click="handleViewLog()">View log</span>
    </div>
    <div class="log" ng-if="current.job && status === 'failed'">
      <i class="fa fa-repeat"></i>
      <span class="log_view" ng-click="deployConfig($ctrl.index)">Restart</span>
    </div>
    <div
      class="play-button"
      ng-class="{disabledButton: !domain || prevStepNotComplited}"
      ng-if="final === undefined && status === 'start' && allowRun && isDisabledFields"
      ng-click="deployConfig($ctrl.index)"
    >
      <i class="fa fa-play-circle"></i>
    </div>
    <div class="success-button" ng-if="status === 'successful'">
      <i class="fa fa-check-circle-o"></i>
    </div>
    <div class="failed-button" ng-if="status === 'failed'">
      <i class="fa fa-times-circle-o"></i>
    </div>
    <div
      class="DashboardGraphs error"
      ng-if="final.status === 'failed' || status === 'failed'"
      style="background-color: #f8d7da;
    border: 1px solid #f5c6cb; padding-bottom: 20px;"
    >
      <i class="fa fa-warning"></i> Something went wrong. See log
      <a ng-if="final.status === 'failed'" target="_blank" ng-href="#/jobs/playbook/{{final['job']}}/">here...</a>
      <a ng-if="status === 'failed'" target="_blank" ng-href="#/jobs/playbook/{{finishedJobId}}/">here...</a>
    </div>
    <div
      class="gear"
      ng-if="final === null && status !== 'failed' && status !== 'successful' || status === 'pending'"
    ></div>
  </div>
  <div class="popup" ng-show="$root.showLogPopup.{{'card_' + index}}">
    <div class="popup-content" style="width: 86%;">
      <div class="popup-header">
        <span class="close" ng-click="closePopup()">&times;</span>
        <h4>Upcoming changes</h4>
      </div>
      <div class="popup-body">
        <div style="overflow: auto; max-height: 400px; margin-bottom: 15px;">
          <div class="DashboardGraphs" ng-show="logStrings" style="text-align: left; padding: 20px 10px; margin-bottom: 20px;">
            <div ng-repeat="log in logStrings track by $index">
              {{log}}
            </div>
          </div>
          <div class="DashboardGraphs" ng-show="commitStrings" style="text-align: left; padding: 20px 10px; margin-bottom: 20px;">
            <div ng-repeat="str in commitStrings">
              <div>
                <table
                  border="1"
                  class="diff_table"
                  ng-repeat="(key, value) in tableData"
                  id="diff_table"
                >
                  <tr ng-click="collapseView(key)" class="clps">
                    <td ng-if="key === 'added'">Added</td>
                    <td ng-if="key === 'deleted'">Deleted</td>
                    <td ng-if="key === 'changes'">Changes</td>
                  </tr>
                  <tr ng_class="hide_{{key}}" ng-hide="isCollapse['{{key}}'] === true">
                    <td>
                      <table
                        border="1"
                        class="table_container"
                        ng-repeat="(k, val) in tableData[key]"
                      >
                        <tr>
                          <td class="strong_title">{{k}}</td>
                        </tr>
                        <tr>
                          <td>
                            <table
                              border="1"
                              ng-class="{diff_gray_table: key != 'deleted' && key != 'added', diff_red_table: key === 'deleted', diff_green_table: key === 'added'}"
                              ng-repeat="(k1, val) in tableData[key][k]"
                              ng-if="key != 'deleted' && key != 'added'"
                            >
                              <tr>
                                <td ng-if="key === 'changes' || key === 'added'"><strong>{{k1}}</strong></td>
                                <td ng-if="key != 'changes' && key != 'added'"><strong>{{k1}}</strong></td>
                                <td ng-if="key != 'added' && key != 'deleted'"></td>
                                <td ng-if="key === 'changes' || key === 'added'"></td>
                              </tr>
                              <!-- CHANGES & NEW VALUES -->
                              <tr ng-if="key === 'changes'">
                                <td><strong>parameter</strong></td>
                                <td ng-if="!!uiEnv1"><strong ng-bind-template="{{uiEnv1}} ({{env1Version.tag}})"></strong></td>
                                <td ng-if="!!uiEnv2"><strong ng-bind-template="{{uiEnv2}} ({{env2Version.tag}})"></strong></td>
                                <td ng-if="!uiEnv1"><strong>Old value</strong></td>
                                <td ng-if="!uiEnv2"><strong>New value</strong></td>
                                <td><strong>path to parameter</strong></td>
                              </tr>
                              <tr ng-repeat="item in tableData[key][k][k1]" ng-if="key === 'changes' || key === 'added'">
                                <td class="td_parameter">{{item.parameter}}</td>
                                <td class="td_parameter">{{item.old_value}}</td>
                                <td class="td_parameter">{{item.new_value}}</td>
                                <td rowspan="1" class="td_parameter pathto">{{item.path_to_parameter}}</td>
                              </tr>
                            </table>
                            <table border="1" class="diff_green_table" ng-if="key === 'added'">
                              <!-- ADDED PARAMS -->
                              <tr ng-if="key === 'added'">
                                <td><strong>Name</strong></td>
                                <td><strong>Path to get configs</strong></td>
                              </tr>
                              <tr ng-repeat="item in tableData[key][k]" ng-if="key === 'added'">
                                <td>{{item.name}}</td>
                                <td ng-if="$first" rowspan="{{tableData[key][k].length}}">{{item.ylm_path_to_get_configs}}</td>
                              </tr>
                            </table>
                            <table border="1" class="diff_red_table" ng-if="key === 'deleted'">
                              <!-- DELETED PARAMS -->
                              <tr ng-repeat="item in tableData[key][k]">
                                <td>{{item}}</td>
                              </tr>
                            </table>
              
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div ng-repeat="hash in commitHashStr">
              {{hash}}
            </div>
          </div>
        </div>
        <button class="btn btn-primary" ng-click="applyPopup()" ng-show="!canNotApply">
          <i class="fa fa-play-circle"></i>
          <span>Apply</span>
        </button>
        <button class="btn" ng-click="declaimChanges()" ng-if="!showCompleted">
          <span>Cancel</span>
        </button>
      </div>
    </div>
  </div>
</div>
